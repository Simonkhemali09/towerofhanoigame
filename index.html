<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snapping Tower of Hanoi</title>
    <style>
        :root {
            --bg: #0f172a;
            --peg-color: #475569;
            --accent: #38bdf8;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body {
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .stats { margin: 20px 0; display: flex; gap: 30px; font-weight: bold; font-size: 1.2rem; }

        .game-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            width: 100%;
            max-width: 600px;
            height: 350px;
            position: relative;
            padding-bottom: 10px;
            border-bottom: 10px solid var(--peg-color);
            border-radius: 0 0 10px 10px;
        }

        .peg {
            width: 30%;
            height: 100%;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        /* The Rod */
        .peg::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 14px;
            height: 85%;
            background: var(--peg-color);
            border-radius: 10px 10px 0 0;
            z-index: -1;
        }

        .disk {
            height: 35px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: grab;
            transition: transform 0.1s;
            position: absolute; /* Changed to absolute for better control */
        }

        .disk.dragging {
            z-index: 1000;
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.6);
        }

        .controls { margin-top: 40px; }
        button {
            padding: 12px 25px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            font-weight: bold;
            color: #0f172a;
            cursor: pointer;
        }

        #win-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>
<body>

    <div class="stats">
        <span>Moves: <span id="moves">0</span></span>
        <span>Time: <span id="time">00:00</span></span>
    </div>

    <div class="game-area" id="game-area">
        <div class="peg" data-idx="0"></div>
        <div class="peg" data-idx="1"></div>
        <div class="peg" data-idx="2"></div>
    </div>

    <div class="controls">
        <button onclick="init()">Reset Game</button>
    </div>

    <div id="win-modal">
        <h1 style="color: var(--accent)">WELL DONE!</h1>
        <p id="win-text"></p>
        <button onclick="init()">Play Again</button>
    </div>

    <script>
        const gameArea = document.getElementById('game-area');
        const pegs = document.querySelectorAll('.peg');
        const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];
        
        let moveCount = 0;
        let activeDisk = null;
        let diskStacks = [[], [], []];
        let startPegIdx = null;
        let timer = null;
        let seconds = 0;

        function init() {
            moveCount = 0;
            seconds = 0;
            diskStacks = [[], [], []];
            document.getElementById('moves').innerText = '0';
            document.getElementById('win-modal').style.display = 'none';
            pegs.forEach(p => p.innerHTML = '');
            
            const numDisks = 4;
            for (let i = numDisks; i > 0; i--) {
                const disk = document.createElement('div');
                disk.className = 'disk';
                disk.dataset.size = i;
                disk.style.width = (60 + (i * 20)) + 'px';
                disk.style.backgroundColor = colors[i - 1];
                disk.innerText = i;
                
                disk.onmousedown = dragStart;
                disk.ontouchstart = dragStart;
                
                diskStacks[0].push(disk);
                gameArea.appendChild(disk);
            }
            renderPositions();
            startTimer();
        }

        function renderPositions() {
            const areaRect = gameArea.getBoundingClientRect();
            diskStacks.forEach((stack, pIdx) => {
                const pegRect = pegs[pIdx].getBoundingClientRect();
                const centerX = pegRect.left + pegRect.width / 2 - areaRect.left;
                
                stack.forEach((disk, dIdx) => {
                    if (disk === activeDisk) return;
                    
                    const diskWidth = parseInt(disk.style.width);
                    disk.style.left = (centerX - diskWidth / 2) + 'px';
                    disk.style.bottom = (dIdx * 38) + 'px'; // 35px height + 3px gap
                    disk.style.top = 'auto'; // Reset top if set during drag
                });
            });
        }

        function dragStart(e) {
            const disk = e.target;
            const currentPegIdx = getDiskPeg(disk);

            // Only top disk
            if (diskStacks[currentPegIdx].indexOf(disk) !== diskStacks[currentPegIdx].length - 1) return;

            activeDisk = disk;
            startPegIdx = currentPegIdx;
            disk.classList.add('dragging');

            const moveHandler = (event) => {
                const cx = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
                const cy = event.type.includes('touch') ? event.touches[0].clientY : event.clientY;
                const areaRect = gameArea.getBoundingClientRect();
                
                // Keep disk centered under finger/mouse
                disk.style.left = (cx - areaRect.left - disk.offsetWidth / 2) + 'px';
                disk.style.top = (cy - areaRect.top - disk.offsetHeight / 2) + 'px';
                disk.style.bottom = 'auto';
            };

            const stopHandler = (event) => {
                const cx = event.type.includes('touch') ? event.changedTouches[0].clientX : event.clientX;
                const cy = event.type.includes('touch') ? event.changedTouches[0].clientY : event.clientY;
                
                disk.classList.remove('dragging');
                finalizeMove(cx, cy);
                
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('mouseup', stopHandler);
                document.removeEventListener('touchend', stopHandler);
            };

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('mouseup', stopHandler);
            document.addEventListener('touchend', stopHandler);
        }

        function finalizeMove(x, y) {
            let targetIdx = -1;
            
            // Detection: which peg is the mouse/finger over?
            pegs.forEach((peg, idx) => {
                const rect = peg.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right) {
                    targetIdx = idx;
                }
            });

            if (targetIdx !== -1 && isValidMove(activeDisk, targetIdx)) {
                if (targetIdx !== startPegIdx) {
                    diskStacks[startPegIdx].pop();
                    diskStacks[targetIdx].push(activeDisk);
                    moveCount++;
                    document.getElementById('moves').innerText = moveCount;
                }
            }
            
            activeDisk = null;
            renderPositions(); // This handles the "Snapping"
            checkWin();
        }

        function isValidMove(disk, tIdx) {
            const stack = diskStacks[tIdx];
            if (stack.length === 0) return true;
            const topDisk = stack[stack.length - 1];
            return parseInt(disk.dataset.size) < parseInt(topDisk.dataset.size);
        }

        function getDiskPeg(disk) {
            return diskStacks.findIndex(stack => stack.includes(disk));
        }

        function startTimer() {
            if(timer) clearInterval(timer);
            timer = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2, '0');
                const s = (seconds%60).toString().padStart(2, '0');
                document.getElementById('time').innerText = `${m}:${s}`;
            }, 1000);
        }

        function checkWin() {
            if (diskStacks[2].length === 4) {
                clearInterval(timer);
                document.getElementById('win-modal').style.display = 'flex';
                document.getElementById('win-text').innerText = `Completed in ${moveCount} moves!`;
            }
        }

        init();
    </script>
</body>
</html>